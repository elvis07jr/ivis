<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iviz - Intelligent Visualization Ideas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #007bff; }
        .column-input { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .column-input input, .column-input select, .column-input textarea { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 120px; }
        .column-input button { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        button#addColumn { background-color: #28a745; margin-top: 10px; }
        button#generateIdeas { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1.1em; }
        .suggestion-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .suggestion-item { background-color: #e9f5ff; border-left: 5px solid #007bff; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .suggestion-item h4 { margin-top: 0; color: #0056b3; }
        .suggestion-item p { margin: 5px 0; }
        .error-message { color: red; margin-top: 10px; }
        .formula-container { background-color: #f0f8ff; border: 1px dashed #a8d4ff; padding: 10px; margin-top: 10px; border-radius: 5px; }
        .formula-item { margin-bottom: 5px; }
        .formula-item strong { color: #0056b3; }
        .metric-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .metric-card-item { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .metric-card-item h4 { color: #007bff; margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }
        .metric-card-item p { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .metric-card-item svg { max-width: 100%; height: auto; display: block; margin: 0 auto; }
        .wireframe-container { background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .wireframe-container svg { display: block; margin: auto; } /* Center SVG */

    </style>
</head>
<body>
    <div class="container">
        <h1>iviz - Intelligent Visualization Ideas</h1>
        <p>Tell us about your dataset's columns, and we'll suggest creative charts, powerful new features, and key metrics!</p>

        <h2>1. Describe Your Columns</h2>
        <form id="columnForm">
            <div id="columnsContainer">
                <!-- Initial column input -->
                <div class="column-input" data-column-id="0">
                    <input type="text" placeholder="Column Name (e.g., Sales)" name="name" required>
                    <select name="data_type" required>
                        <option value="">Select Type</option>
                        <option value="numerical">Numerical</option>
                        <option value="categorical">Categorical</option>
                        <option value="date">Date</option>
                        <option value="text">Text</option>
                        <option value="boolean">Boolean</option>
                    </select>
                    <select name="semantic_type">
                        <option value="">Select Semantic Type (Optional)</option>
                        <option value="currency">Currency</option>
                        <option value="percentage">Percentage</option>
                        <option value="latitude">Latitude</option>
                        <option value="longitude">Longitude</option>
                        <option value="country">Country</option>
                        <option value="city">City</option>
                        <option value="zip_code">Zip Code</option>
                        <option value="identifier">Identifier</option>
                        <option value="rating">Rating</option>
                        <option value="key_performance_indicator">KPI</option>
                        <option value="segment">Segment</option>
                    </select>
                    <textarea placeholder="Description (e.g., Total revenue from a transaction)" name="description" rows="1" required></textarea>
                    <button type="button" class="remove-column" style="display:none;">Remove</button>
                </div>
            </div>
            <button type="button" id="addColumn">Add Another Column</button>
            <br><br>
            <button type="submit" id="generateIdeas">Generate Ideas</button>
            <span id="loadingIndicator" style="display:none;">Loading...</span>
            <div id="errorMessage" class="error-message"></div>
        </form>

        <div id="results" class="suggestion-section" style="display: none;">
            <h2>2. Your Visualization Ideas</h2>
            <div id="chartSuggestions"></div>

            <h2>3. Feature Engineering Ideas</h2>
            <div id="featureEngineeringSuggestions"></div>

            <h2>4. Key Metric Cards</h2>
            <div id="metricCardSuggestions" class="metric-card-grid"></div>
        </div>
    </div>

    <script>
        const columnsContainer = document.getElementById('columnsContainer');
        const addColumnBtn = document.getElementById('addColumn');
        const columnForm = document.getElementById('columnForm');
        const resultsDiv = document.getElementById('results');
        const chartSuggestionsDiv = document.getElementById('chartSuggestions');
        const featureEngineeringSuggestionsDiv = document.getElementById('featureEngineeringSuggestions');
        const metricCardSuggestionsDiv = document.getElementById('metricCardSuggestions');
        const errorMessageDiv = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        let columnIdCounter = 1;

        function addColumnInput() {
            const newColumnDiv = document.createElement('div');
            newColumnDiv.className = 'column-input';
            newColumnDiv.dataset.columnId = columnIdCounter++;
            newColumnDiv.innerHTML = `
                <input type="text" placeholder="Column Name" name="name" required>
                <select name="data_type" required>
                    <option value="">Select Type</option>
                    <option value="numerical">Numerical</option>
                    <option value="categorical">Categorical</option>
                    <option value="date">Date</option>
                    <option value="text">Text</option>
                    <option value="boolean">Boolean</option>
                </select>
                <select name="semantic_type">
                    <option value="">Select Semantic Type (Optional)</option>
                    <option value="currency">Currency</option>
                    <option value="percentage">Percentage</option>
                    <option value="latitude">Latitude</option>
                    <option value="longitude">Longitude</option>
                    <option value="country">Country</option>
                    <option value="city">City</option>
                    <option value="zip_code">Zip Code</option>
                    <option value="identifier">Identifier</option>
                    <option value="rating">Rating</option>
                    <option value="key_performance_indicator">KPI</option>
                    <option value="segment">Segment</option>
                </select>
                <textarea placeholder="Description" name="description" rows="1" required></textarea>
                <button type="button" class="remove-column">Remove</button>
            `;
            columnsContainer.appendChild(newColumnDiv);
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const removeButtons = document.querySelectorAll('.remove-column');
            if (removeButtons.length === 1) {
                removeButtons[0].style.display = 'none'; // Hide if only one column
            } else {
                removeButtons.forEach(btn => btn.style.display = 'block');
            }
        }

        columnsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-column')) {
                event.target.closest('.column-input').remove();
                updateRemoveButtons();
            }
        });

        addColumnBtn.addEventListener('click', addColumnInput);

        columnForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            errorMessageDiv.textContent = '';
            chartSuggestionsDiv.innerHTML = '';
            featureEngineeringSuggestionsDiv.innerHTML = '';
            metricCardSuggestionsDiv.innerHTML = ''; // <-- Clear new section
            resultsDiv.style.display = 'none';

            const columnInputs = document.querySelectorAll('.column-input');
            const columnsData = [];

            columnInputs.forEach(div => {
                const name = div.querySelector('input[name="name"]').value.trim();
                const type = div.querySelector('select[name="data_type"]').value;
                const semantic_type = div.querySelector('select[name="semantic_type"]').value;
                const description = div.querySelector('textarea[name="description"]').value.trim();

                const columnEntry = { name, data_type: type, description };
                if (semantic_type) {
                    columnEntry.semantic_type = semantic_type;
                }

                if (name && type && description) {
                    columnsData.push(columnEntry);
                } else {
                    errorMessageDiv.textContent = 'Please fill out Name, Type, and Description for each column.';
                    throw new Error('Missing required fields.'); // Stop processing by throwing error
                }
            });

            if (columnsData.length === 0 && !errorMessageDiv.textContent) { // Check if error already set
                errorMessageDiv.textContent = 'Please add at least one column.';
                return;
            }
            if (errorMessageDiv.textContent) return; // Stop if errors were found

            loadingIndicator.style.display = 'inline'; // Show loading indicator

            try {
                // Ensure this URL matches your FastAPI server (e.g., http://localhost:8000)
                const response = await fetch('http://localhost:8000/generate-ideas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(columnsData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to generate ideas.');
                }

                const data = await response.json();
                
                // --- Display Chart Suggestions ---
                if (data.chart_suggestions.length > 0) {
                    data.chart_suggestions.forEach(chart => {
                        chartSuggestionsDiv.innerHTML += `
                            <div class="suggestion-item">
                                <h4>${chart.title} (${chart.chart_type})</h4>
                                <div class="wireframe-container">${chart.wireframe.svg_data}</div>
                                <p><strong>Columns:</strong> ${chart.columns_used.join(', ')}</p>
                                <p><strong>How to:</strong> ${chart.how_to}</p>
                            </div>
                        `;
                    });
                } else {
                    chartSuggestionsDiv.innerHTML = '<p>No chart suggestions found for these columns.</p>';
                }

                // --- Display Feature Engineering Suggestions ---
                if (data.feature_engineering_suggestions.length > 0) {
                    data.feature_engineering_suggestions.forEach(fe => {
                        let formulasHtml = fe.formulas.map(f => `
                            <div class="formula-item">
                                <strong>${f.tool}:</strong> <code>${f.formula_string}</code>
                                ${f.example_data_context ? `<p class="context-text">${f.example_data_context}</p>` : ''}
                            </div>
                        `).join('');

                        featureEngineeringSuggestionsDiv.innerHTML += `
                            <div class="suggestion-item">
                                <h4>New Feature: ${fe.new_feature_name}</h4>
                                <p><strong>Description:</strong> ${fe.description}</p>
                                <p><strong>Involves:</strong> ${fe.columns_involved.join(', ')}</p>
                                <p><strong>Potential Charts:</strong> ${fe.potential_charts.join(', ')}</p>
                                <div class="formula-container">
                                    <h5>Formulas:</h5>
                                    ${formulasHtml}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    featureEngineeringSuggestionsDiv.innerHTML = '<p>No feature engineering suggestions found for these columns.</p>';
                }

                // --- Display Metric Card Suggestions --- <-- NEW SECTION
                if (data.metric_card_suggestions.length > 0) {
                    data.metric_card_suggestions.forEach(mc => {
                        let formulasHtml = mc.formulas.map(f => `
                            <div class="formula-item">
                                <strong>${f.tool}:</strong> <code>${f.formula_string}</code>
                                ${f.example_data_context ? `<p class="context-text">${f.example_data_context}</p>` : ''}
                            </div>
                        `).join('');

                        const wireframeHtml = mc.wireframe && mc.wireframe.svg_data ?
                            `<div class="wireframe-container">${mc.wireframe.svg_data}</div>` :
                            '<div class="wireframe-container"><p>(No wireframe available)</p></div>';

                        metricCardSuggestionsDiv.innerHTML += `
                            <div class="metric-card-item">
                                ${wireframeHtml}
                                <h4>${mc.title}</h4>
                                <p><strong>Metric:</strong> ${mc.metric_name}</p>
                                <p><strong>Calculates:</strong> ${mc.calculation_how_to}</p>
                                ${mc.context ? `<p><strong>Context:</strong> ${mc.context}</p>` : ''}
                                <div class="formula-container">
                                    <h5>Formulas:</h5>
                                    ${formulasHtml}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    metricCardSuggestionsDiv.innerHTML = '<p>No metric card suggestions found for these columns.</p>';
                }

                resultsDiv.style.display = 'block';

            } catch (error) {
                errorMessageDiv.textContent = `Error: ${error.message}`;
                console.error('Error fetching suggestions:', error);
            } finally {
                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }
        });

        // Initialize with one column input
        updateRemoveButtons();
    </script>
</body>
</html>